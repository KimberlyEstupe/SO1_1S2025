FROM golang:1.21 as builder

WORKDIR /app

COPY . .

RUN go mod init weather && \
    go get google.golang.org/grpc && \
    go get google.golang.org/protobuf/cmd/protoc-gen-go && \
    go get google.golang.org/grpc/cmd/protoc-gen-go-grpc && \
    go get github.com/rabbitmq/amqp091-go && \
    go install google.golang.org/protobuf/cmd/protoc-gen-go && \
    go install google.golang.org/grpc/cmd/protoc-gen-go-grpc

# Install protoc
RUN apt-get update && apt-get install -y protobuf-compiler && \
    mkdir -p proto

# Generate proto files
COPY proto/weather.proto ./proto/
RUN protoc --go_out=. --go-grpc_out=. ./proto/weather.proto

# Build the application
RUN cd grpc-server-rabbitmq && go build -o /app/server

# Final stage
FROM debian:bookworm-slim

WORKDIR /app

# Install ca-certificates for HTTPS
RUN apt-get update && apt-get install -y ca-certificates && rm -rf /var/lib/apt/lists/*

COPY --from=builder /app/server /app/server

EXPOSE 50051

CMD ["/app/server"]